name: Next.js CI/CD - Build and Deploy

# ワークフローが実行されるタイミング
on:
  push:
    branches: [ main ] # ★ releaseブランチにプッシュされた時に実行

# ワークフロー全体で使う環境変数
env:
  # ★ Docker Hubのユーザー名と、アプリのイメージ名を指定
  DOCKERHUB_USERNAME: rnagashiro # ★あんたのDocker Hubユーザー名
  IMAGE_NAME: my-nextjs-app      # ★あんたが決めたイメージ名

  # ★ マニフェスト用リポジトリの情報を指定
  MANIFEST_REPO: RyoNagashiro9280/ac-manifest-tss # ★ユーザー名/リポジトリ名
  MANIFEST_PATH: next/values.yaml  # ★Helmチャートのvalues.yamlまでのパス

jobs:
  # ジョブ1: Dockerイメージをビルドしてプッシュする
  build-and-push-image:
    runs-on: ubuntu-latest
    # ジョブの出力を定義。ここで定義した値は、他のジョブから参照できる
    outputs:
      IMAGE_TAG: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }} # ★GitHub Secretsに設定する必要がある

      - name: Generate image tag from Git commit
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            # Gitのコミットハッシュ (短い形式) をタグとして使う
            type=sha,prefix=,format=short

      # --- Runner (アプリ本体) イメージのビルド ---
      - name: Build and push Docker image (Runner)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }} # 例: rnagashiro/my-nextjs-app:d65b5c1
          labels: ${{ steps.meta.outputs.labels }}
          # ★★★ ここに変数を追加して焼き込みます ★★★
          build-args: |
            DATABASE_URL=${{ secrets.DATABASE_URL_FOR_BUILD }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            NEXT_PUBLIC_APP_URL=https://infopia.nqg1t0.com
            NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
            NEXTAUTH_URL=https://infopia.nqg1t0.com
          no-cache: true
          # "runner" ステージをビルド対象として指定
          target: runner

      # --- Migrator (DBマイグレーション用) イメージのビルド ---
      - name: Build and push Migrator image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          # タグの末尾に '-migrator' をつける
          tags: ${{ steps.meta.outputs.tags }}-migrator # 例: rnagashiro/my-nextjs-app:d65b5c1-migrator
          labels: ${{ steps.meta.outputs.labels }}
          # ★ Migratorも同じbuilderステージを使うので、キャッシュヒットのために同じ引数を渡すのが無難
          build-args: |
            DATABASE_URL=${{ secrets.DATABASE_URL_FOR_BUILD }}
            NEXT_PUBLIC_APP_URL=https://infopia.nqg1t0.com
            NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
            NEXTAUTH_URL=https://infopia.nqg1t0.com
          no-cache: true
          # ビルド対象として 'migrator' ステージを指定
          target: migrator

      # --- Sandbox (コード実行環境) イメージのビルド ---
      - name: Build and push Sandbox image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          # タグの末尾に '-sandbox' をつける (例: ...:d65b5c1-sandbox)
          tags: ${{ steps.meta.outputs.tags }}-sandbox
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true
          # ★ Dockerfile内の 'sandbox-env' ステージを指定
          target: sandbox-env

  # ジョブ2: Kubernetesマニフェスト (values.yaml) を更新する
  update-manifest:
    runs-on: ubuntu-latest
    needs: build-and-push-image # build-and-push-imageジョブが終わってから実行

    steps:
      - name: Checkout Manifest Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.MANIFEST_REPO }}
          token: ${{ secrets.PAT_FOR_MANIFEST_REPO }} # ★マニフェストリポジトリを書き換えるためのPAT

      - name: Update Helm chart values.yaml
        uses: mikefarah/yq@v4
        with:
          # yqコマンドを使って、values.yamlの中の image.tag の値を書き換える
          # needs.build-and-push-image.outputs.IMAGE_TAG で、前のジョブで作ったタグを参照
          cmd: yq -i '.image.tag = "${{ needs.build-and-push-image.outputs.IMAGE_TAG }}"' ${{ env.MANIFEST_PATH }}

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions-bot@github.com"
          # 変更がなければ、コミットせずに終了する
          if ! git diff --quiet ${{ env.MANIFEST_PATH }}; then
            git add ${{ env.MANIFEST_PATH }}
            git commit -m "Update image tag for ${{ env.IMAGE_NAME }} to ${{ needs.build-and-push-image.outputs.IMAGE_TAG }}"
            git push
          else
            echo "No changes to commit."
          fi